# 長時間エージェント

> 出典: [Effective Harnesses for Long-Running Agents](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents)

Anthropicの研究は、AIエージェントが複数のコンテキストウィンドウにわたって進捗を維持することが困難という重大な課題に取り組んでいます。

---

## 核心的な問題

長時間実行エージェントは、「各新しいセッションが以前の記憶なしに始まる」離散的なセッションに直面します。これにより、エージェントは以下のいずれかを強いられます：

- 一度にすべてを試みる → タスク途中でコンテキストが枯渇
- 早期に完了を宣言する → 不完全な結果

---

## 提案されたソリューション：2エージェントアーキテクチャ

### イニシャライザーエージェント（最初のセッションのみ）

1. **環境セットアップ**: `init.sh`スクリプトを設定して開発環境を実行
2. **進捗ドキュメント**: `claude-progress.txt`ファイルを作成して作業履歴を記録
3. **機能リスト**: JSON形式で包括的な機能リストを生成

### コーディングエージェント（後続セッション）

1. **単一機能作業**: 一度に1つの機能を段階的に処理
2. **Gitコミット**: 説明的なメッセージでコミットを作成
3. **進捗更新**: 終了前に進捗ドキュメントを更新

---

## 主要な環境コンポーネント

### 1. 機能リスト

- 200以上の構造化された機能を「failing」とマーク
- エージェントが早期に勝利宣言することを防止
- JSON形式で不適切な変更を防ぐ

### 2. バージョン管理

- Git履歴と進捗ファイルの組み合わせ
- 「新しいコンテキストウィンドウで開始する際に、作業状態を迅速に理解」できる

### 3. テストインフラストラクチャ

- ユニットテストだけに頼らず、ブラウザ自動化ツール（Puppeteer MCP）を活用
- エンドツーエンド機能を検証

### 4. 起動プロトコル

各セッション開始時に以下を実行：
1. Gitログを読む
2. 進捗ファイルを確認
3. 基本的な検証テストを実行

---

## 実装手順

### ステップ1: イニシャライザーの設定

```bash
# init.sh の例
#!/bin/bash
npm install
npm run build
npm run test:basic
```

### ステップ2: 進捗追跡ファイルの構造

```markdown
# claude-progress.txt の例

## 完了した機能
- ユーザー認証（コミット: abc123）
- データベース接続（コミット: def456）

## 現在の作業
- API エンドポイント実装

## 次のステップ
- フロントエンド統合
- エラーハンドリング

## 既知の問題
- ログイン時のタイムアウト問題（要調査）

## メモ
- PostgreSQLはDockerで起動必須
```

### ステップ3: 機能リストのJSON形式

```json
{
  "features": [
    {
      "id": "auth-001",
      "name": "User Login",
      "status": "passing",
      "commit": "abc123",
      "tests": ["login.test.ts"]
    },
    {
      "id": "api-002",
      "name": "REST Endpoints",
      "status": "in_progress",
      "progress": "50%",
      "commit": null,
      "blockers": []
    },
    {
      "id": "ui-003",
      "name": "Dashboard UI",
      "status": "failing",
      "commit": null,
      "dependencies": ["api-002"]
    }
  ],
  "metadata": {
    "total": 3,
    "passing": 1,
    "in_progress": 1,
    "failing": 1,
    "last_updated": "2025-12-12T10:00:00Z"
  }
}
```

---

## セッション開始プロトコル

```bash
# 各セッション開始時に実行
git log --oneline -n 10     # Git履歴確認
cat claude-progress.txt      # 進捗確認
npm run test:basic           # 基本テスト

# features.jsonを確認
cat .claude/features.json | jq '.features[] | select(.status == "in_progress")'
```

---

## ベストプラクティス

### 段階的進捗の重要性

> 段階的進捗は「エージェントが一度にやりすぎる傾向に対処するために重要」

- 大きなタスクを小さな達成可能な目標に分割
- 各ステップでコミットとドキュメント更新
- 次のセッションで容易に再開可能な状態を維持

### JSON形式の活用

- 機能追跡にJSON形式を使用
- 不適切な変更を防止
- プログラムによる解析が容易

### 構造化ドキュメント

- 以前の作業についての推測を排除
- 明確な完了基準を設定
- コンテキスト間での知識移転を効率化

---

## 重要な洞察

1. **JSON形式**が機能追跡に最適
2. **段階的進捗**がエージェントの過剰作業傾向を抑制
3. **構造化ドキュメント**が推測を排除
4. **Git + 進捗ファイル**の組み合わせが状態理解を高速化

---

## チェックリスト

### セッション開始時

- [ ] `git log --oneline -10` で最近のコミットを確認
- [ ] `claude-progress.txt` を読む
- [ ] `.claude/features.json` で次の機能を特定
- [ ] 基本テストを実行

### 作業中

- [ ] **一度に1つの機能**のみ実装
- [ ] 小さなステップでコミット
- [ ] 進捗ファイルを頻繁に更新

### セッション終了前

- [ ] 現在の作業状態をコミット
- [ ] `claude-progress.txt` を更新
- [ ] `features.json` のステータスを更新

---

## 未解決の研究課題

以下の領域で研究が継続中：

- マルチエージェントアーキテクチャ
- Web開発以外への一般化（科学研究、財務モデリングなど）
- より効率的な状態管理手法
