# Advanced Tool Use（高度なツール利用）

> 出典: [Introducing Advanced Tool Use](https://www.anthropic.com/engineering/advanced-tool-use), [Writing Effective Tools for Agents](https://www.anthropic.com/engineering/writing-tools-for-agents), [The "think" Tool](https://www.anthropic.com/engineering/claude-think-tool)

Anthropicは、Claudeが動的にツールを発見、学習、実行できる3つのベータ機能をリリースしました。数百または数千のツールを扱う場合のスケーラビリティ課題に対処します。

---

## 3つの主要機能

### 1. Tool Search Tool（ツール検索ツール）

すべてのツール定義を事前にロードするのではなく、オンデマンドでツールを発見：

```json
{
  "name": "my_tool",
  "defer_loading": true
}
```

**主なメリット**：
- トークン消費を**85%削減**
- 精度向上：Opus 4が49%→74%、Opus 4.5が79.5%→88.1%
- 10Kトークン以上のツール定義で最も効果的

### 2. Programmatic Tool Calling（プログラムによるツール呼び出し）

個別のAPIリクエストではなく、サンドボックス環境で実行されるPythonコードでツールをオーケストレート：

```python
# 従来: 19回以上の推論パス
# プログラム的: 1回のコード実行

results = []
for item in items:
    result = tool_call(item)
    results.append(result)
return aggregate(results)
```

**効率性向上**：
- 複雑なリサーチタスクでトークン使用量が43,588→27,297（**37%削減**）
- 中間結果をClaudeのコンテキストから除外

### 3. Tool Use Examples（ツール使用例）

JSONスキーマだけでは表現できない具体的な使用パターンを提供：

- オプションパラメータの包含
- API規約の明確化
- 1-5個の現実的なデータ例

**効果**: 精度が72%→90%に向上

---

## ベストプラクティス

1. **主要なボトルネックに基づいて機能を戦略的に重ねる**
2. **検索発見のため明確で説明的なツール名とドキュメントを維持**
3. **現実的なデータを例に使用**（ツールごとに1-5個）
4. **コードベースのオーケストレーション用に戻り値の形式を明確にドキュメント**

---

## 開始方法

```python
# ベータヘッダーが必要
headers = {
    "betas": ["advanced-tool-use-2025-11-20"]
}
```

---

## Think Tool（シンクツール）

「think」ツールは、「Claudeが行動前に計画を深く検討し反復」させる機能です。

### 拡張思考との違い

| 特徴 | 拡張思考 | Think Tool |
|------|----------|------------|
| タイミング | 応答生成**前** | 応答生成**後**（情報処理時） |
| 適用場面 | 初期計画 | 長いツールチェーン、複数ステップ会話 |

### パフォーマンス向上

| ベンチマーク | 改善率 |
|-------------|--------|
| 航空会社ドメイン（τ-Bench） | 0.370 → 0.570（**54%向上**） |
| 小売ドメイン | 0.783 → 0.812 |
| SWE-Bench | 平均1.6%向上 |

### 実装例

```python
tools = [
    {
        "name": "think",
        "description": "複雑な問題を分析し、計画を立てるために使用",
        "input_schema": {
            "type": "object",
            "properties": {
                "thought": {
                    "type": "string",
                    "description": "現在の思考プロセス"
                }
            }
        }
    }
]
```

### 適切な使用場面

✅ **使用すべき場面**：
- ツール出力の慎重な分析
- ポリシー遵守が必須の環境
- 各ステップが前のステップに依存する逐次的な意思決定

❌ **使用すべきでない場面**：
- 単一またはパラレルなツール呼び出しのみ
- 制約が少ない単純な指示遵守タスク

---

## 効果的なツールの作成

### 3段階の開発プロセス

#### ステージ1: プロトタイプ構築
1. Claude Codeを使用して初期ツールを作成
2. 適切なドキュメント（llms.txtファイルなど）を準備
3. MCPサーバーまたはDesktop Extensionsでローカルテスト

#### ステージ2: 包括的な評価
1. 現実的な評価タスクを生成
2. プログラムによる評価実行
3. 精度以外のメトリクスも収集（実行時間、トークン消費量、エラー率）

#### ステージ3: 反復的最適化
1. Claude Codeで評価トランスクリプトを分析
2. ツール実装を自動的に改善
3. 過学習を防ぐためホールドアウトテストセットを維持

---

## 5つの主要原則

### 原則1: 適切なツール選択

```
❌ 多くの汎用ラッパー
✅ 少数の目的特化ツール
```

### 原則2: 名前空間の活用

```
asana_search
asana_projects_search
asana_tasks_create
```

### 原則3: 意味のあるコンテキスト

```json
// 悪い例
{"id": "a1b2c3d4-e5f6-7890"}

// 良い例
{"project_name": "Q4マーケティング", "id": "a1b2c3d4"}
```

### 原則4: トークン効率

- ページネーション、フィルタリング、トランケーションを実装
- 賢明なデフォルト値を設定
- 効率的な戦略に導くエラーメッセージを提供

### 原則5: プロンプトエンジニアリング

> 「ツールの説明に対する小さな改良でも劇的な改善をもたらすことがある」

明確で曖昧さのないツール説明を作成します。
