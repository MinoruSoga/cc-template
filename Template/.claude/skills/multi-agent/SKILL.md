---
name: multi-agent
description: マルチエージェントシステム設計
triggers:
  - "マルチエージェント"
  - "並列処理"
  - "オーケストレーター"
  - "サブエージェント"
---

# マルチエージェントシステム設計

> オーケストレーター・ワーカーパターンで複雑なタスクを分解・並列実行

## 使用場面

- 複数の専門分野が必要なタスク
- 高価値タスク（~15xトークンコストが許容される場合）
- 並列処理で大幅な時間短縮が見込める場合
- 大量の情報を同時に探索する必要がある場合

---

## アーキテクチャ

```
┌─────────────────────┐
│   リードエージェント      │  ← 戦略策定・統合
│   (Claude Opus)        │
└──────────┬──────────┘
           │
     ┌─────┴─────┐
     ↓           ↓           ↓
┌────────┐ ┌────────┐ ┌────────┐
│ サブA  │ │ サブB  │ │ サブC  │  ← 並列検索・実行
│(Sonnet)│ │(Sonnet)│ │(Sonnet)│
└────────┘ └────────┘ └────────┘
     │           │           │
     └─────┬─────┘
           ↓
     ┌──────────┐
     │ 統合処理  │  ← 結果統合・引用
     └──────────┘
```

---

## 8原則チェックリスト

### 計画フェーズ

- [ ] **1. エージェントのように思考**
  - このタスクでエージェントはどう動くか？
  - どこで行き詰まる可能性があるか？
  - 失敗モードを事前に特定したか？

- [ ] **2. 委任を明確に定義**
  - 各サブエージェントの検索範囲は明確か？
  - 期待する出力形式を指定したか？
  - 完了条件を設定したか？

- [ ] **3. 複雑さに応じてスケール**
  - シンプルなクエリ → 1-2エージェント
  - 中程度のクエリ → 3-5エージェント
  - 複雑なクエリ → 5+エージェント

### 設計フェーズ

- [ ] **4. ツール設計を重視**
  - 各ツールの説明は明確か？
  - 誤ったツール選択を防ぐヒューリスティクスがあるか？
  - 使用場面の例を含めたか？

- [ ] **5. エージェント自己改善**
  - 失敗時に原因を分析する仕組みがあるか？
  - 改善提案を生成できるか？

### 実行フェーズ

- [ ] **6. 広く始めて絞り込む**
  1. 広範な探索検索
  2. 関連領域の特定
  3. 深掘り調査
  4. 結果の統合

- [ ] **7. 思考をガイド**
  - 計画時: 拡張思考（extended thinking）を活用
  - 評価時: インターリーブ思考で判断

- [ ] **8. 積極的に並列化**
  - 独立したタスクは同時実行
  - `asyncio.gather` パターンで90%時間削減

---

## 実践例

### コード探索の並列化

```python
# 並列で複数の観点から検索
results = await asyncio.gather(
    search_by_function_name(query),
    search_by_file_pattern(query),
    search_by_keyword(query)
)
# 結果を統合
combined = merge_search_results(results)
```

### Claude Codeでの活用

```
1. Explore エージェントで並列検索:
   - 「src/auth/ の認証ロジックを調査」
   - 「src/api/ のエンドポイントを確認」
   - 「tests/ のテストパターンを分析」

2. 各結果を統合:
   - 認証: JWT + セッション併用
   - API: RESTful、v2エンドポイント
   - テスト: Jest + Supertest

3. 統合した情報で計画:
   - 新機能は既存パターンに従う
   - テストは同様のスタイルで作成
```

---

## パフォーマンス比較

| 構成 | トークン | 品質 | 時間 |
|------|---------|------|------|
| シングル（Opus） | 1x | ベースライン | 100% |
| マルチ（Opus+Sonnet） | ~15x | +90.2% | -90% |

**注意**: コスト増加は高価値タスクでのみ正当化

---

## 委任テンプレート

```markdown
## サブエージェントへの指示

### 担当領域
[具体的なトピック/ファイル範囲]

### タスク
[実行すべき具体的なアクション]

### 期待する出力
- 形式: [JSON/Markdown/リスト]
- 含めるべき情報: [必須項目]
- 制限: [文字数/項目数]

### 完了条件
- [ ] [具体的な完了基準1]
- [ ] [具体的な完了基準2]

### 注意事項
- [避けるべきこと]
- [優先すべきこと]
```

---

## トラブルシューティング

### サブエージェントが的外れな結果を返す

原因: 委任の指示が曖昧
対策: 検索範囲と期待出力を具体化

### 並列実行が遅い

原因: 依存関係のあるタスクを並列化
対策: 依存関係を分析し、独立タスクのみ並列化

### コストが高すぎる

原因: 過剰なサブエージェント数
対策: 複雑さに応じてスケール（原則3）を再確認

---

## 参照

- [マルチエージェントシステム詳細](../docs/15-multi-agent-systems.md)
- [エージェント設計パターン](../docs/13-agent-design-patterns.md)
- [How We Built Our Multi-Agent Research System](https://www.anthropic.com/engineering/multi-agent-research-system)
