# 効果的なエージェント構築ガイド

> 出典: [Building Effective Agents](https://www.anthropic.com/engineering/building-effective-agents), [Building agents with the Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)

## 概要

Anthropicのエンジニアリングチームは、多くの組織との協業経験に基づき、効果的なAIエージェント構築の包括的なガイドを公開しています。最も成功した実装は「複雑なフレームワークではなく、シンプルで組み合わせ可能なパターン」を使用しているという洞察が核心です。

## ワークフローとエージェントの違い

### ワークフロー
- LLMとツールが**事前定義されたコードパス**を通じて動作
- 予測可能性が高く、明確に定義されたタスクに適している

### エージェント
- LLMが**独自にプロセスとツール使用を指示**
- 柔軟性が高く、オープンエンドな問題に適している

## エージェントを構築すべき場面

以下のケースでエージェントが適しています：

1. タスクのステップが事前に予測できない
2. フィードバックに基づく複数回の反復が必要
3. モデルの意思決定権限が適切
4. 信頼できる環境で操作が行われる

**注意**: 多くのアプリケーションでは、単一のLLM呼び出しを検索とコンテキスト例で最適化するだけで十分です。

## 6つの基本設計パターン

### 1. プロンプトチェーン（Prompt Chaining）
タスクを連続したステップに分割し、各出力を次の入力として使用します。

```
入力 → LLM処理1 → 出力1 → LLM処理2 → 出力2 → 最終結果
```

### 2. ルーティング（Routing）
入力を分類し、専門化されたハンドラーに振り分けます。

```
入力 → 分類器 → 専門ハンドラーA/B/C → 結果
```

### 3. 並列化（Parallelization）
タスクを同時に実行します（セクショニングまたは投票アプローチ）。

- **セクショニング**: 異なるサブタスクを並行処理
- **投票**: 同じタスクを複数回実行して結果を集約

### 4. オーケストレーター・ワーカー（Orchestrator-Workers）
中央LLMが専門化されたワーカーに動的に委任します。

```
オーケストレーター
    ├── ワーカーA（検索担当）
    ├── ワーカーB（分析担当）
    └── ワーカーC（生成担当）
```

### 5. 評価者・最適化（Evaluator-Optimizer）
反復的なフィードバックループによる改善を行います。

```
生成 → 評価 → フィードバック → 改善 → 再評価...
```

### 6. 自律エージェント（Autonomous Agents）
環境からのフィードバックを受けながら独立して動作します。

## 3つの核心原則

1. **シンプルさ** - エージェントアーキテクチャは単純に
2. **透明性** - 計画ステップを可視化
3. **明確なツールドキュメント** - テスト済みの文書化（Agent-Computer Interface設計）

## Claude Agent SDKでのエージェントループ

### 1. コンテキスト収集

| 手法 | 説明 |
|------|------|
| ファイルシステム検索 | `grep`や`tail`などのbashスクリプトで大規模ファイルを効率処理 |
| セマンティック検索 | ベクトル化されたチャンク検索（初期段階では不要） |
| サブエージェント | 並列処理と独立したコンテキストウィンドウで大量情報を管理 |
| コンパクション | 長時間稼働時の自動要約機能 |

### 2. アクション実行

- **ツール**: Claudeのコンテキストウィンドウで目立つため優先される
- **Bashスクリプト**: 一般的な柔軟な操作に使用
- **コード生成**: 複雑な操作の正確な実装
- **MCP**: Slack、GitHub、Google Drive等との標準統合

### 3. 検証と改善

- **ルール定義**: 明確な失敗条件の設定
- **ビジュアルフィードバック**: レイアウト、スタイリング確認
- **LLMジャッジ**: 別モデルによる品質評価

### 4. テストと最適化

評価すべきポイント：
- 情報不足の場合 → 検索API構造の改善
- 反復的失敗時 → 正式ルールの追加
- エラー修正不可時 → 代替ツールの提供
- パフォーマンス変動時 → 代表的テストセットの構築

## ツール開発のベストプラクティス

### Do（推奨）

- トレーニングデータに自然に出現するフォーマットを使用
- 十分なコンテキストを例とエッジケースで提供
- モデルの使用エラーを特定するため徹底的にテスト
- パラメータに「ミス防止」原則を適用

### Don't（非推奨）

- モデル出力を複雑にするフォーマットオーバーヘッドを避ける
- 不必要に複雑なツールインターフェースを作らない

## 実世界のアプリケーション例

### カスタマーサポート
会話インターフェースとツール統合を組み合わせ、データアクセス、アクション実行、解決率測定を実現。

### コーディングエージェント
自動テストをフィードバックとして活用し、SWE-benchベンチマークで実証済みのGitHub課題解決。

## フレームワークガイダンス

> Claude Agent SDKなどのツールは開発を簡素化しますが、推奨は「まずLLM APIを直接使用する」ことです。多くのパターンは数行のコードで実装できます。

複雑さは、よりシンプルなアプローチが要件を満たさないことが明確に示された場合にのみ増やすべきです。

## 対応可能なエージェントタイプ

| タイプ | 用途例 |
|--------|--------|
| ファイナンスエージェント | ポートフォリオ分析、投資評価 |
| 個人アシスタント | 旅行予約、カレンダー管理 |
| カスタマーサポート | チケット処理、エスカレーション |
| リサーチエージェント | 大規模文書検索、データ総合 |

## 実装開始のステップ

1. [Claude Agent SDK公式ドキュメント](https://docs.claude.com/en/api/agent-sdk/overview)を確認
2. 既存利用者は[マイグレーションガイド](https://docs.claude.com/en/docs/claude-code/sdk/migration-guide)を参照
3. シンプルなパターンから始め、必要に応じて複雑化
