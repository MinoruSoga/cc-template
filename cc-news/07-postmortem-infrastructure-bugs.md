# 3つのインフラストラクチャバグの事後分析

> 出典: [A Postmortem of Three Recent Issues](https://www.anthropic.com/engineering/a-postmortem-of-three-recent-issues)

## 概要

Anthropicは2025年8月から9月にかけてClaudeのレスポンス品質を低下させた3つのインフラバグについて詳細な技術報告書を公開しました。これらの問題は現在すべて解決済みです。

## 3つの重大な障害

### 障害1: コンテキストウィンドウルーティングエラー

| 項目 | 詳細 |
|------|------|
| 発生日 | 8月5日 |
| 初期影響 | Sonnet 4リクエストの0.8% |
| 悪化日 | 8月29日（負荷分散変更後） |
| 最大影響 | 8月31日に16%まで拡大 |
| 影響範囲 | Claude Code利用者の約30% |

**問題**: ルーティングロジックの欠陥により、一部のリクエストが誤ったコンテキストウィンドウサイズで処理された。

### 障害2: 出力破損

| 項目 | 詳細 |
|------|------|
| 原因 | 8月25日のTPUサーバー設定ミス |
| 症状 | 英語プロンプトに対してタイ語や中国語文字が挿入 |
| 影響モデル | Opus 4.1、Opus 4、Sonnet 4 |

**問題**: サーバー設定の誤りにより、トークン生成プロセスで文字化けが発生。

### 障害3: XLA:TPUコンパイラミスコンパイル

| 項目 | 詳細 |
|------|------|
| 原因 | トークン選択コード改善時に潜在バグが露出 |
| 影響モデル | Haiku 3.5、Opus 3、Sonnet 4 |
| 変更内容 | 「近似トップk」から「正確なトップk」への移行 |

**問題**: コンパイラの最適化が意図しない動作を引き起こした。

## 検出が困難だった理由

### 評価システムの限界

> 「ノイズの多い評価に依存しすぎていた」

従来の評価では：
- 小さな品質低下を検出できない
- 統計的ノイズに埋もれる
- 特定の障害パターンを見逃す

### プライバシー制約

- ユーザーフィードバック未報告の相互作用にエンジニアがアクセス不可
- バグ再現に必要な情報が不足
- デバッグプロセスが大幅に遅延

## 検出の課題を示す具体例

```
従来のアプローチ:
評価スコア: 85% ± 3%

実際:
- 正常時: 87%
- 障害時: 83%

→ ノイズ範囲内のため異常を検出できず
```

## 改善措置

### 1. より感度の高い評価システム

```
改善点:
- 細粒度の品質メトリクス
- 特定の障害パターン検出
- 統計的感度の向上
```

### 2. 本番システムでの継続的品質監視

```
実装:
- リアルタイム品質スコアリング
- 異常検出アラート
- 自動ロールバック機能
```

### 3. ユーザープライバシーを保護しながらデバッグツールを強化

```
バランス:
- プライバシー保護 ←→ デバッグ能力
- 匿名化された品質シグナル
- オプトインベースのフィードバック
```

### 4. ユーザーフィードバックの促進

フィードバック方法：
- `/bug`コマンド
- 「不満」ボタン

> ユーザーからのフィードバックが早期検出の鍵

## 学んだ教訓

### 技術的教訓

1. **評価の多様化**
   - 単一のメトリクスに依存しない
   - 複数の視点から品質を測定

2. **段階的ロールアウト**
   - 変更を段階的に展開
   - 影響範囲を限定

3. **監視の強化**
   - リアルタイム監視
   - 早期警告システム

### 組織的教訓

1. **透明性の重要性**
   - 問題発生時は迅速に公開
   - ユーザーへの誠実なコミュニケーション

2. **フィードバックループ**
   - ユーザーフィードバックの価値
   - 継続的な改善サイクル

## Anthropicの姿勢

> 「モデル品質は交渉の余地がない」

効率より品質を優先する姿勢を明確に示しています：

```
優先順位:
1. 品質
2. 信頼性
3. 効率
```

## 今後の対策

### 短期的対策

- 評価システムの感度向上
- 監視ダッシュボードの改善
- アラートしきい値の調整

### 長期的対策

- 自動品質保証パイプライン
- 機械学習ベースの異常検出
- ユーザーフィードバック統合システム

## ユーザーへの推奨事項

### 問題を発見した場合

1. **`/bug`コマンドを使用**
   - 問題の詳細を報告
   - 再現手順があれば記載

2. **「不満」ボタンをクリック**
   - 簡単なフィードバック
   - 品質監視に貢献

3. **具体的なフィードバックを提供**
   - 期待した結果
   - 実際の結果
   - コンテキスト情報

### フィードバックの価値

```
ユーザーフィードバック → 早期検出 → 迅速な修正 → 品質向上
```

ユーザーからの報告が、問題の早期発見と解決に直接貢献します。

## まとめ

この事後分析から学べる重要なポイント：

| 学び | 対策 |
|------|------|
| 評価の限界 | 多角的な品質測定 |
| プライバシーとデバッグのバランス | 匿名化されたシグナル活用 |
| ユーザーフィードバックの価値 | フィードバック促進機能 |
| 透明性の重要性 | オープンな事後分析公開 |

Anthropicは今後も品質を最優先に、継続的な改善に取り組んでいます。
