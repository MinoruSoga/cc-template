---
name: context-engineering
description: コンテキスト管理とトークン効率化
triggers:
  - "コンテキスト"
  - "トークン"
  - "効率化"
  - "圧縮"
---

# コンテキストエンジニアリング

> 「望む結果の可能性を最大化する、最小の高信号トークンセットを見つけ出す」

## 使用場面

- 大量のデータを扱う場合
- 長時間セッション
- トークン制限に近づいた場合
- 複数ファイルを横断した分析

---

## 基本原則

### コンテキストロット問題

トークンが増加するとモデルの想起精度が低下します：
- Transformerのn²ペアワイズ関係が原因
- 重要な情報が埋もれる

### 解決策：高信号・低ノイズ

1. **必要な情報のみ**をコンテキストに含める
2. **不要な情報を積極的に除外**
3. **動的にロード**（事前に全部入れない）

---

## 実践手順

### 1. 現在のコンテキスト使用状況を確認

```
現在扱っている情報:
- ファイル数: X
- 主要なコード: Y行
- 不要な可能性があるもの: Z
```

### 2. ジャストインタイム検索を実施

```
❌ 避けるべき: 関連しそうなファイルを全部読み込む
✅ 推奨: 必要になった時点で動的にロード
```

**実践例:**
```
# 全ファイルを事前ロードしない
✅ まずファイル一覧（パス）だけ取得
✅ 必要なファイルを特定してから内容を読む
✅ 読んだ後、不要になったら忘れる
```

### 3. コンパクション（圧縮）実行

長時間セッションで実施：

```markdown
## 保持すべき情報
- アーキテクチャ決定: [具体的内容]
- 実装した機能: [リスト]
- 次のステップ: [明確なタスク]

## 破棄可能な情報
- 探索中に読んだが関係なかったファイル
- 試行錯誤の詳細
- 中間的な議論
```

### 4. 重要情報の保持を確認

以下は必ず保持：
- [ ] 現在のタスクの目標
- [ ] 重要な技術的決定とその理由
- [ ] 次のアクション
- [ ] ブロッカーや未解決の問題

---

## テクニック集

### 識別子ベースの管理

```
# ファイル内容ではなくパスを保持
重要ファイル:
- src/auth/login.ts (認証ロジック)
- src/api/users.ts (ユーザーAPI)

# 必要な時に読み込む
> 認証の詳細を確認するため login.ts を読み込み
```

### サブエージェントの活用

並列で情報収集し、要約のみを受け取る：

```
Explore エージェント → 「認証関連のファイルを探して」
              ↓
  要約: 「src/auth/ に3ファイル、主要なのは login.ts」
```

### 段階的な深掘り

```
1. 広く浅く: ディレクトリ構造を確認
2. 関連領域を特定: 「src/auth/ が関連」
3. 深掘り: 特定ファイルの詳細を読む
4. 統合: 必要な情報だけを保持
```

---

## チェックリスト

### セッション開始時
- [ ] 目標を明確化（何を達成するか）
- [ ] 必要な情報の範囲を見積もり
- [ ] 不要な情報のロードを避ける計画

### 作業中
- [ ] 読んだファイルが本当に必要か確認
- [ ] 中間結果を要約してから次へ
- [ ] 探索結果は要約のみ保持

### 長時間セッション
- [ ] 定期的にコンパクションを検討
- [ ] 重要な決定を明文化
- [ ] 進捗ファイルに記録

---

## 参照

- [コンテキストエンジニアリング詳細](../docs/14-context-engineering.md)
- [Contextual Retrieval](https://www.anthropic.com/engineering/contextual-retrieval)
