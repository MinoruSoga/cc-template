# Claude Codeのセキュリティとサンドボックス

> 出典: [Beyond Permission Prompts: Making Claude Code More Secure and Autonomous](https://www.anthropic.com/engineering/claude-code-sandboxing)

## 概要

Anthropicは、セキュリティを強化しながら許可プロンプトを**84%削減**する2つのサンドボックス機能をClaude Codeに導入しました。これらの機能により、開発者はプロンプトインジェクション攻撃から保護されながら、より自律的に作業できるようになります。

## 重要なセキュリティ境界

### 2つの必須分離メカニズム

効果的なサンドボックスには**両方**の分離メカニズムが必要です：

#### 1. ファイルシステム分離

```
✅ 許可: /Users/dev/project/
❌ 拒否: /etc/passwd
❌ 拒否: ~/.ssh/
❌ 拒否: システムファイル全般
```

- Claudeのアクセスを特定のディレクトリに制限
- 侵害されても機密システムファイルの変更を防止

#### 2. ネットワーク分離

```
✅ 許可: api.example.com
✅ 許可: github.com
❌ 拒否: malicious-server.com
❌ 拒否: 未承認のサーバー
```

- プロキシを通じて承認済みサーバーへの接続を制限
- データ流出やマルウェアダウンロードを防止

### 両方が必要な理由

> 「効果的なサンドボックスにはファイルシステムとネットワークの両方の分離が必要」

片方だけでは、侵害されたエージェントがサンドボックス制限を回避できてしまいます：
- ファイルのみ: ネットワーク経由でデータ流出可能
- ネットワークのみ: ローカルファイルを改ざん可能

## 2つの新機能

### 1. Sandboxed Bash Tool（サンドボックス化Bashツール）

**特徴**：
- OSレベルのプリミティブを使用するリサーチプレビュー
  - Linux: bubblewrap
  - macOS: seatbelt
- 定義された制限内での自律的なコマンド実行
- 無許可アクセス試行時の即時通知
- 特定のファイルパスとドメインに対して完全に設定可能

**設定例**：
```bash
# サンドボックス設定の確認
/sandbox

# 出力例:
# Filesystem: /Users/dev/project/ (read-write)
# Network: github.com, api.anthropic.com (allowed)
```

### 2. Claude Code on the Web

**特徴**：
- 分離されたクラウドサンドボックスでセッションを実行
- 機密資格情報をサンドボックス外部に保持
  - Gitトークン
  - 署名キー
- スコープ付き資格情報ですべてのGit操作を管理するカスタムプロキシサービス
- 認証トークン付加前にGit操作を検証

**アーキテクチャ**：
```
ユーザー ─→ Claude Code Web ─→ クラウドサンドボックス
                                    │
                                    ↓
                              プロキシサービス
                                    │
                              (検証・認証)
                                    │
                                    ↓
                              Git リポジトリ
```

## 始め方

### ローカル環境での設定

```bash
# Claude Codeで設定詳細を確認
/sandbox
```

### Web版の利用

[claude.com/code](https://claude.com/code)にアクセス

### カスタムエージェント開発

GitHubでオープンソース化されたサンドボックスコードを統合できます。

## 設定のベストプラクティス

### 最小権限の原則

```yaml
# 推奨設定
filesystem:
  allowed:
    - /path/to/project  # プロジェクトディレクトリのみ
  denied:
    - ~/.ssh
    - ~/.aws
    - /etc

network:
  allowed:
    - github.com
    - api.anthropic.com
    - 必要なAPIエンドポイントのみ
```

### プロジェクト固有の設定

各プロジェクトに応じた設定を作成：

```json
{
  "sandbox": {
    "enabled": true,
    "filesystem": {
      "root": "./",
      "exclude": ["node_modules", ".git"]
    },
    "network": {
      "allowlist": ["npm.registry.org"]
    }
  }
}
```

## セキュリティ上の考慮事項

### プロンプトインジェクション対策

サンドボックスにより、悪意のあるプロンプトが注入されても：
- システムファイルへのアクセス不可
- 外部への不正な通信不可
- 被害範囲がサンドボックス内に限定

### 資格情報の保護

```
✅ 良い例: プロキシサービスが資格情報を管理
❌ 悪い例: エージェントが直接資格情報にアクセス
```

## 結果

これらの機能により：
- **84%の許可プロンプト削減**
- 開発者の生産性維持
- セキュリティの大幅な向上
- 「より安全で高速なエージェント体験」を提供

## まとめ

| 機能 | メリット | 対象ユーザー |
|------|----------|--------------|
| Sandboxed Bash | ローカルでの自律実行 | 開発者 |
| Web版 | クラウド分離環境 | 全ユーザー |
| オープンソースコード | カスタム統合 | エージェント開発者 |

セキュリティと自律性のバランスを取りながら、開発者が効率的に作業できる環境を提供します。
