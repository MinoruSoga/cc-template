# Claude Code ベストプラクティス

> 出典: [Claude Code: Best Practices for Agentic Coding](https://www.anthropic.com/engineering/claude-code-best-practices), [Raising the Bar on SWE-bench Verified](https://www.anthropic.com/engineering/swe-bench-sonnet)

## 概要

Claude Codeは、エンジニアがClaudeを開発ワークフローに統合できるCLIツールです。成功は、厳格なルールへの固執ではなく、カスタマイズと実験に依存します。

---

# Part 1: 設定戦略

## CLAUDE.mdファイル

CLAUDE.mdは特別な設定ファイルで、自動的にコンテキストをロードします。

### 含めるべき内容

```markdown
# プロジェクト設定

## Bashコマンド
- ビルド: `npm run build`
- テスト: `npm test`
- リント: `npm run lint`

## コードスタイル
- TypeScript使用
- 関数には明示的な戻り値型を記述
- エラーハンドリングにはResultパターンを使用

## テスト手順
1. 単体テスト: `npm test`
2. 統合テスト: `npm run test:integration`
3. E2Eテスト: `npm run test:e2e`

## プロジェクト固有の注意点
- APIキーは環境変数から取得
- データベース接続は`src/db/connection.ts`で管理
```

### ベストプラクティス

> 「簡潔で人間が読みやすく」保ち、頻繁に使用するプロンプトと同様に効果を反復的に改善

## ツール権限

Claudeが自律的に実行できるツールをカスタマイズ：

### 設定方法

1. **セッション中**: 「Always allow」を選択
2. **コマンド**: `/permissions`を使用
3. **設定ファイル**: 直接編集
4. **CLIフラグ**: 一時的な権限用

```bash
# 例: 特定のコマンドを常に許可
claude --allow-bash "npm test"
```

## MCP統合

Model Context Protocolサーバーへの接続方法：

1. **プロジェクト設定**: `.mcp.json`ファイル
2. **グローバル設定**: ユーザー設定
3. **チェックイン設定**: リポジトリに含める

```json
// .mcp.json
{
  "servers": {
    "puppeteer": {
      "command": "npx",
      "args": ["@anthropic-ai/mcp-puppeteer"]
    }
  }
}
```

---

# Part 2: 推奨ワークフロー

## Explore, Plan, Code, Commit

### ステップ1: 探索

```
最初にコーディングせずにファイルを読んでもらう
「src/auth/ディレクトリの構造を説明して」
```

### ステップ2: 計画

```
実装前に詳細な計画を作成
「この機能を実装する計画を立てて。深く考えて。」
```

> 「think」という言語を使用すると、より徹底的な分析のために拡張思考モードがトリガーされます

### ステップ3: コード

計画に基づいて実装を進める

### ステップ4: コミット

変更を適切にコミット

## テスト駆動開発（TDD）

### 手順

1. **テストを先に書く**（失敗を確認）
2. **反復的にコーディング**
3. **テストがパスするまで続ける**

```
「まずユーザー認証のテストを書いて、失敗することを確認してから実装して」
```

Claudeに明確な成功基準を提供します。

## ビジュアル反復

### 手順

1. スクリーンショットやデザインモックを提供
2. 複数回の反復で実装を改善
3. 出力がターゲットと一致するまで続ける

```
「このデザイン画像と同じレイアウトを実装して」
[画像を添付]
```

---

# Part 3: 最適化テクニック

## 効率的なプロンプティング

### Do（推奨）

- 具体的な指示を最初に提供
- 画像、図、URLを直接プロンプトに含める
- タスク間で`/clear`を使用してコンテキストを集中
- 複雑な操作にはチェックリストを作成

### Don't（非推奨）

- 曖昧な指示で開始
- コンテキストを蓄積させすぎる
- 複数の無関係なタスクを1つのセッションで処理

## Git連携

バージョン管理と履歴分析を活用：

```bash
# 履歴から学習
「最近のコミットを分析して、このプロジェクトのコーディングパターンを教えて」

# 変更の追跡
「前回のコミットからの変更点をまとめて」
```

---

# Part 4: 高度なパターン

## 並列ワークフロー

複数のClaude Codeインスタンスを使用：

```bash
# ターミナル1: 機能A
cd feature-a && claude

# ターミナル2: 機能B
cd feature-b && claude
```

## Git Worktrees

同時に複数のタスクを処理：

```bash
# メインブランチ
git worktree add ../feature-branch feature-branch

# 各worktreeで別のClaude Codeセッション
```

## ヘッドレスモード

CI/CDパイプラインでの自動化：

```bash
# 非対話モードで実行
claude --headless "このバグを修正して"
```

---

# Part 5: SWE-benchからの教訓

## 成果

Claude 3.5 Sonnetは**SWE-bench Verifiedで49%**を達成し、当時の最先端45%を超えました。

## エージェント設計哲学

### 最小限のスキャフォールディング

- プロンプト
- Bashツール
- ファイルエディタ

この3つだけで、モデルに問題解決アプローチの自律性を与えます。

### 2つの必須ツール

#### 1. Bashツール

```yaml
機能:
  - コマンド実行
  - 制限事項の詳細な説明（インターネットアクセスなしなど）
  - ベストプラクティス（バックグラウンドプロセス、出力管理）
```

#### 2. Editツール

```yaml
機能:
  - ファイルの表示、作成、変更
  - 文字列置換による編集
要件:
  - 絶対パス必須
  - 正確な文字列マッチング
```

> 「人間ユーザー向けと同様に、モデル向けのツールインターフェース設計に多くの注意を払うべき」

## 実践的なワークフロー

エージェントが従うステップ：

1. **リポジトリ構造を探索**
2. **再現スクリプトを作成**
3. **修正を特定して実装**
4. **テストで検証**
5. **エッジケースを処理**

## パフォーマンス上の課題

| 課題 | 説明 |
|------|------|
| トークン集約 | 成功した実行で100k+トークン消費 |
| グレーディング複雑性 | 環境セットアップの問題解決が必要 |
| 隠れたテスト | 評価基準が見えず成功判断が困難 |
| マルチモーダルギャップ | ビジュアルファイルデバッグが限定的 |

## 重要なポイント

Claude 3.5 Sonnetを使用したパフォーマンス改善には：

1. **ツールインターフェースを慎重に設計**
2. **最小限で柔軟なスキャフォールディングを維持**
3. **モデルの意思決定を尊重**

これにより、モデルが最大限の能力を発揮できます。
